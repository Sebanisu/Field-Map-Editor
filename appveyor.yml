image:
  - Visual Studio 2019
clone_folder: c:\projects\source


environment:
  PYTHON: "C:\\Python38-x64\\python.exe"

cache:
  - c:\conan\data

before_build:
  - cmd: >-      
      "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
      
      mkdir bin\Release
      
      powershell Compress-Archive -Path src\opengl\opengl_version\res -DestinationPath bin\Release\res.zip
      
      powershell Compress-Archive -Path src -DestinationPath bin\Release\src.zip


build_script:
  - cmd: >-      
      set PATH=%PATH%;C:\Users\appveyor\AppData\Roaming\Python\Python38\Scripts
      
      set CONAN_USER_HOME=c:\conan\data
      
      "%PYTHON%" -m pip install --user conan
      
      mkdir build
      
      cmake -S c:\projects\source -B ./build -G Ninja -DCMAKE_BUILD_TYPE=Release  
      
      cmake --build ./build --config "Release"

after_build:
  - cmd: move bin\*.exe bin\Release

test_script:
  - cmd: cd build && ctest -C Debug

artifacts:
  - path: 'bin/Release/*.*'
    name: Canary

before_deploy:
  - git -c http.https://github.com/.extraheader="AUTHORIZATION: token $(APPVEYOR_TOKEN)" ls-remote --tags --refs https://github.com/Sebanisu/Field-Map-Editor Canary | xargs git -c http.https://github.com/.extraheader="AUTHORIZATION: token $(APPVEYOR_TOKEN)" push --delete origin

deploy:
  - provider: GitHub
    release: Canary
    description: Automatic Test build version ($(APPVEYOR_BUILD_VERSION)). Updated ($(APPVEYOR_REPO_COMMIT_TIMESTAMP))
    auth_token:
      secure: $(APPVEYOR_TOKEN)
    artifact: Canary
    prerelease: true
    force_update: true
    delete_release: true
    on:
      branch: main